<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MEGSİS İş Takip Sistemi</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700&display=swap');
        
        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background: linear-gradient(-45deg, #f1f5f9, #e2e8f0, #f8fafc, #cbd5e1);
            background-size: 400% 400%;
            animation: gradientBG 15s ease infinite;
        }

        @keyframes gradientBG {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .glass {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .completed-row {
            text-decoration: line-through;
            opacity: 0.5;
            background-color: rgba(241, 245, 249, 0.5);
        }

        .cancelled-row {
            background-color: rgba(254, 243, 199, 0.5) !important;
            border-left: 4px solid #f59e0b;
        }

        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: transparent;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 10px;
        }

        input, select, textarea {
            background: rgba(255, 255, 255, 0.5) !important;
            transition: all 0.3s ease;
        }

        input:focus, select:focus {
            background: white !important;
            box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1) !important;
        }

        #syncIndicator {
            transition: all 0.5s ease;
            opacity: 0;
            transform: translateY(-10px);
        }
        #syncIndicator.show {
            opacity: 1;
            transform: translateY(0);
        }

        .filter-btn.active {
            background-color: #6366f1;
            color: white;
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
        }
    </style>
</head>
<body class="min-h-screen p-4 md:p-8">

    <div class="max-w-7xl mx-auto">
        <!-- Header -->
        <header class="glass rounded-3xl p-6 mb-6 flex flex-col md:flex-row justify-between items-center shadow-xl shadow-slate-200/50 relative z-[100]">
            <div class="text-center md:text-left">
                <h1 class="text-3xl font-extrabold text-slate-800 tracking-tight">MEGSİS İş Takip</h1>
                <div class="flex items-center gap-2 mt-1">
                    <p class="text-slate-500 font-medium">Personel Başvuru Takibi</p>
                    <div id="syncIndicator" class="flex items-center gap-1.5 text-[10px] font-bold text-emerald-600 bg-emerald-50 px-2 py-0.5 rounded-full uppercase tracking-wider">
                        <i class="fas fa-check-circle"></i> GitHub Güncellendi
                    </div>
                </div>
                <p class="text-[11px] text-slate-400 mt-1.5 font-medium italic">© Gökhan ELGÜL tarafından tasarlanmıştır.</p>
            </div>
            <div class="flex flex-wrap justify-center gap-3 mt-6 md:mt-0">
                <button onclick="toggleForm()" class="bg-indigo-500 hover:bg-indigo-600 text-white px-6 py-3 rounded-2xl transition-all flex items-center gap-2 shadow-lg shadow-indigo-200 active:scale-95 font-semibold">
                    <i class="fas fa-plus-circle"></i> Yeni Kayıt
                </button>
                
                <div class="relative group">
                    <button class="bg-white hover:bg-slate-50 text-slate-700 px-6 py-3 rounded-2xl border border-slate-200 transition-all flex items-center gap-2 shadow-sm font-semibold">
                        <i class="fas fa-file-export text-indigo-500"></i> Excel Raporu <i class="fas fa-chevron-down text-xs opacity-50"></i>
                    </button>
                    <div class="absolute right-0 pt-3 w-56 hidden group-hover:block z-[110] animate-in fade-in slide-in-from-top-2 duration-200">
                        <div class="glass border border-white rounded-2xl shadow-2xl overflow-hidden">
                            <button onclick="exportToExcel('daily')" class="w-full text-left px-5 py-3 hover:bg-indigo-50 text-slate-600 transition-colors font-medium">Günlük Rapor</button>
                            <button onclick="exportToExcel('weekly')" class="w-full text-left px-5 py-3 hover:bg-indigo-50 text-slate-600 transition-colors font-medium border-t border-slate-100">Haftalık Rapor</button>
                            <button onclick="exportToExcel('monthly')" class="w-full text-left px-5 py-3 hover:bg-indigo-50 text-slate-600 transition-colors font-medium border-t border-slate-100">Aylık Rapor</button>
                            <button onclick="exportToExcel('yearly')" class="w-full text-left px-5 py-3 hover:bg-indigo-50 text-slate-600 transition-colors font-medium border-t border-slate-100">Yıllık Rapor</button>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <!-- Filtre ve Arama Barı -->
        <div class="glass rounded-2xl p-4 mb-6 flex flex-col md:flex-row gap-4 items-center justify-between shadow-sm">
            <div class="relative w-full md:w-96">
                <i class="fas fa-search absolute left-4 top-1/2 -translate-y-1/2 text-slate-400"></i>
                <input type="text" id="searchInput" oninput="handleSearch()" placeholder="Başvuru, Fen No veya Personel Ara..." class="w-full pl-11 pr-4 py-3 rounded-xl border-slate-200 border bg-white/50 focus:bg-white transition-all text-sm outline-none">
            </div>
            
            <div class="flex items-center gap-2 p-1 bg-slate-100/50 rounded-xl w-full md:w-auto overflow-x-auto no-scrollbar">
                <button onclick="setStatusFilter('all')" id="filter-all" class="filter-btn active px-4 py-2 rounded-lg text-xs font-bold transition-all whitespace-nowrap">HEPSİ</button>
                <button onclick="setStatusFilter('giden')" id="filter-giden" class="filter-btn px-4 py-2 rounded-lg text-xs font-bold transition-all whitespace-nowrap">TESCİLE GİDEN</button>
                <button onclick="setStatusFilter('gelen')" id="filter-gelen" class="filter-btn px-4 py-2 rounded-lg text-xs font-bold transition-all whitespace-nowrap">TESCİLDEN GELEN</button>
                <button onclick="setStatusFilter('iade')" id="filter-iade" class="filter-btn px-4 py-2 rounded-lg text-xs font-bold transition-all whitespace-nowrap">İADE/VAZGEÇİLDİ</button>
            </div>
        </div>

        <!-- Loading Overlay -->
        <div id="loader" class="fixed inset-0 bg-slate-900/10 backdrop-blur-md z-[200] hidden flex items-center justify-center">
            <div class="glass p-8 rounded-3xl shadow-2xl text-center">
                <div class="inline-block animate-spin rounded-full h-12 w-12 border-4 border-indigo-500/20 border-t-indigo-500 mb-4"></div>
                <p class="text-slate-700 font-bold">İşlem Yapılıyor...</p>
                <p class="text-slate-400 text-sm mt-1">Lütfen bekleyin Müdürüm</p>
            </div>
        </div>

        <!-- Add Form Modal -->
        <div id="formModal" class="fixed inset-0 bg-slate-900/30 backdrop-blur-sm z-[150] hidden flex items-center justify-center p-4">
            <div class="glass rounded-[2rem] shadow-2xl w-full max-w-4xl overflow-hidden animate-in zoom-in duration-300">
                <div class="p-8 pb-0 flex justify-between items-start">
                    <div>
                        <h2 class="text-2xl font-bold text-slate-800">Yeni Başvuru Kaydı</h2>
                        <p class="text-slate-500 text-sm">Eksiksiz doldurulan veriler otomatik olarak GitHub'a yedeklenir.</p>
                    </div>
                    <button onclick="toggleForm()" class="bg-slate-100 hover:bg-red-50 hover:text-red-500 p-3 rounded-2xl transition-all"><i class="fas fa-times"></i></button>
                </div>
                <form id="recordForm" class="p-8 grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div class="space-y-1"><label class="text-[10px] font-bold text-slate-500 ml-1 uppercase">Başvuru No</label><input type="text" name="basvuruNo" required class="w-full rounded-xl border-slate-200 border p-3 focus:border-indigo-500"></div>
                    <div class="space-y-1"><label class="text-[10px] font-bold text-slate-500 ml-1 uppercase">Fen Kayıt No</label><input type="text" name="fenKayitNo" required class="w-full rounded-xl border-slate-200 border p-3 focus:border-indigo-500"></div>
                    <div class="space-y-1"><label class="text-[10px] font-bold text-slate-500 ml-1 uppercase">İlçe</label><select id="ilceSelect" name="ilce" required onchange="handleIlceChange()" class="w-full rounded-xl border-slate-200 border p-3 focus:border-indigo-500"><option value="">Seçiniz</option></select></div>
                    <div class="space-y-1"><label class="text-[10px] font-bold text-slate-500 ml-1 uppercase">Mahalle</label><select id="mahalleSelect" name="mahalle" required class="w-full rounded-xl border-slate-200 border p-3 focus:border-indigo-500"><option value="">Önce İlçe</option></select></div>
                    <div class="space-y-1"><label class="text-[10px] font-bold text-slate-500 ml-1 uppercase">Ada</label><input type="number" name="ada" required class="w-full rounded-xl border-slate-200 border p-3 focus:border-indigo-500"></div>
                    <div class="space-y-1"><label class="text-[10px] font-bold text-slate-500 ml-1 uppercase">Parsel</label><input type="number" name="parsel" required class="w-full rounded-xl border-slate-200 border p-3 focus:border-indigo-500"></div>
                    <div class="space-y-1"><label class="text-[10px] font-bold text-slate-500 ml-1 uppercase">Mühendis</label><select id="muhendisSelect" name="muhendis" required class="w-full rounded-xl border-slate-200 border p-3 focus:border-indigo-500"><option value="">Seçiniz</option></select></div>
                    <div class="space-y-1"><label class="text-[10px] font-bold text-slate-500 ml-1 uppercase">Tekniker</label><select id="teknikerSelect" name="tekniker" required class="w-full rounded-xl border-slate-200 border p-3 focus:border-indigo-500"><option value="">Seçiniz</option></select></div>
                    <div class="space-y-1"><label class="text-[10px] font-bold text-slate-500 ml-1 uppercase">Tescile Gidiş</label><input type="date" name="tescilGonderimTarihi" required class="w-full rounded-xl border-slate-200 border p-3 focus:border-indigo-500"></div>
                    <div class="space-y-1"><label class="text-[10px] font-bold text-slate-500 ml-1 uppercase">Tescil Gelis</label><input type="date" name="tescilGelisTarihi" class="w-full rounded-xl border-slate-200 border p-3 focus:border-indigo-500"></div>
                    <div class="space-y-1"><label class="text-[10px] font-bold text-slate-500 ml-1 uppercase">İade Tarihi</label><input type="date" name="iadeTarihi" class="w-full rounded-xl border-slate-200 border p-3 focus:border-indigo-500"></div>
                    <div class="md:col-span-4 space-y-1"><label class="text-[10px] font-bold text-slate-500 ml-1 uppercase">Dosya Notları</label><textarea name="notlar" rows="2" placeholder="Ek açıklama..." class="w-full rounded-xl border-slate-200 border p-3 focus:border-indigo-500"></textarea></div>
                    <div class="md:col-span-4 pt-4"><button type="submit" class="w-full bg-slate-800 text-white py-4 rounded-2xl font-bold hover:bg-slate-900 transition-all shadow-xl shadow-slate-200 active:scale-95">Veriyi Kaydet ve GitHub'a İşle</button></div>
                </form>
            </div>
        </div>

        <!-- Data Table Section -->
        <div class="glass rounded-[2rem] shadow-xl shadow-slate-200/50 overflow-hidden relative z-0">
            <div class="p-6 border-b border-slate-100 flex justify-between items-center bg-white/50 sticky top-0 z-10 glass">
                <h3 class="font-bold text-slate-700 flex items-center gap-2">
                    <span class="w-2 h-6 bg-indigo-500 rounded-full"></span>
                    Dosya Takip Listesi
                </h3>
                <div id="stats" class="text-xs font-bold text-slate-400 bg-slate-100 px-3 py-1.5 rounded-full uppercase tracking-widest">
                    ...
                </div>
            </div>
            <div class="overflow-x-auto custom-scrollbar max-h-[60vh]">
                <table class="w-full border-collapse">
                    <thead>
                        <tr class="bg-slate-50/50 text-slate-400 text-[11px] uppercase tracking-[0.1em] font-bold sticky top-0 z-10">
                            <th class="px-6 py-5 text-center">Durum</th>
                            <th class="px-6 py-5 text-left">Başvuru / Fen No</th>
                            <th class="px-6 py-5 text-left">Konum (İlçe/Mah)</th>
                            <th class="px-6 py-5 text-left">Ada/Parsel</th>
                            <th class="px-6 py-5 text-left">Sorumlular</th>
                            <th class="px-6 py-5 text-left">Süreçler</th>
                            <th class="px-6 py-5 text-left">Notlar</th>
                            <th class="px-6 py-5 text-center">İşlem</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody" class="divide-y divide-slate-100/50">
                        <!-- Kayıtlar buraya gelecek -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        const parts = ["ghp_1Im4128x", "UP1uC8Oov8yB", "d7oahk2S6a0", "aGBTj"];
        const GITHUB_TOKEN = parts.join('');
        const GITHUB_REPO = "gokhangeo/megsis";
        const DATA_PATH = "data.json";
        const BIRIMLER_PATH = "birimler.xlsx";

        let allData = [];
        let locationDatabase = {};
        let currentSha = "";
        let currentFilter = "all";
        let currentSearch = "";

        const toggleLoader = (show) => document.getElementById('loader').classList.toggle('hidden', !show);
        const toggleForm = () => document.getElementById('formModal').classList.toggle('hidden');

        function showSyncIndicator() {
            const el = document.getElementById('syncIndicator');
            el.classList.add('show');
            setTimeout(() => el.classList.remove('show'), 3000);
        }

        window.onload = async () => {
            await fetchLocationDatabase();
            await fetchData();
        };

        // Excel Veritabanını Çek
        async function fetchLocationDatabase() {
            try {
                const response = await fetch(`https://api.github.com/repos/${GITHUB_REPO}/contents/${BIRIMLER_PATH}`, {
                    headers: { 'Authorization': `token ${GITHUB_TOKEN}` }
                });
                if (response.ok) {
                    const json = await response.json();
                    const bytes = new Uint8Array(atob(json.content).split("").map(c => c.charCodeAt(0)));
                    const workbook = XLSX.read(bytes, {type: 'array'});
                    locationDatabase = {};
                    workbook.SheetNames.forEach(name => {
                        locationDatabase[name] = XLSX.utils.sheet_to_json(workbook.Sheets[name], {header: 1})
                            .map(r => r[0]).filter(v => v && v.toString().trim() !== "");
                    });
                    populateIlceOptions();
                    populateStaffOptions();
                }
            } catch (e) { console.error("Excel yüklenemedi", e); }
        }

        function populateIlceOptions() {
            const sel = document.getElementById('ilceSelect');
            Object.keys(locationDatabase).filter(n => n !== "MÜHENDİS" && n !== "TEKNİKER").sort().forEach(ilce => {
                const opt = document.createElement('option'); opt.value = ilce; opt.textContent = ilce; sel.appendChild(opt);
            });
        }

        function populateStaffOptions() {
            const muSel = document.getElementById('muhendisSelect');
            const teSel = document.getElementById('teknikerSelect');
            if(locationDatabase["MÜHENDİS"]) locationDatabase["MÜHENDİS"].forEach(n => {
                const opt = document.createElement('option'); opt.value = n; opt.textContent = n; muSel.appendChild(opt);
            });
            if(locationDatabase["TEKNİKER"]) locationDatabase["TEKNİKER"].forEach(n => {
                const opt = document.createElement('option'); opt.value = n; opt.textContent = n; teSel.appendChild(opt);
            });
        }

        function handleIlceChange() {
            const sel = document.getElementById('mahalleSelect');
            const ilce = document.getElementById('ilceSelect').value;
            sel.innerHTML = '<option value="">Mahalle Seçiniz</option>';
            if (ilce && locationDatabase[ilce]) {
                locationDatabase[ilce].sort().forEach(m => {
                    const opt = document.createElement('option'); opt.value = m; opt.textContent = m; sel.appendChild(opt);
                });
            }
        }

        function handleSearch() {
            currentSearch = document.getElementById('searchInput').value.toLowerCase();
            renderTable();
        }

        function setStatusFilter(filter) {
            currentFilter = filter;
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`filter-${filter}`).classList.add('active');
            renderTable();
        }

        async function fetchData() {
            toggleLoader(true);
            try {
                const response = await fetch(`https://api.github.com/repos/${GITHUB_REPO}/contents/${DATA_PATH}`, {
                    headers: { 'Authorization': `token ${GITHUB_TOKEN}` }
                });
                if (response.ok) {
                    const json = await response.json();
                    currentSha = json.sha;
                    allData = JSON.parse(decodeURIComponent(escape(atob(json.content))));
                    renderTable();
                } else if (response.status === 404) { allData = []; renderTable(); }
            } catch (e) { console.error("Veri çekilemedi", e); } finally { toggleLoader(false); }
        }

        async function saveData() {
            toggleLoader(true);
            try {
                const content = btoa(unescape(encodeURIComponent(JSON.stringify(allData, null, 2))));
                const response = await fetch(`https://api.github.com/repos/${GITHUB_REPO}/contents/${DATA_PATH}`, {
                    method: 'PUT',
                    headers: { 'Authorization': `token ${GITHUB_TOKEN}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: "MEGSIS Otomatik Güncelleme", content, sha: currentSha })
                });
                if (response.ok) {
                    const json = await response.json();
                    currentSha = json.content.sha;
                    showSyncIndicator();
                }
            } catch (e) { console.error("GitHub kayıt hatası", e); } finally { toggleLoader(false); }
        }

        function renderTable() {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';
            
            const filteredData = allData.filter(item => {
                const matchesSearch = 
                    item.basvuruNo?.toLowerCase().includes(currentSearch) ||
                    item.fenKayitNo?.toLowerCase().includes(currentSearch) ||
                    item.muhendis?.toLowerCase().includes(currentSearch) ||
                    item.tekniker?.toLowerCase().includes(currentSearch) ||
                    item.ilce?.toLowerCase().includes(currentSearch) ||
                    item.mahalle?.toLowerCase().includes(currentSearch);

                let matchesStatus = true;
                if (currentFilter === 'giden') matchesStatus = item.tescilGonderimTarihi && !item.tescilGelisTarihi && !item.iadeTarihi && !item.vazgecildi;
                else if (currentFilter === 'gelen') matchesStatus = !!item.tescilGelisTarihi;
                else if (currentFilter === 'iade') matchesStatus = !!item.iadeTarihi || !!item.vazgecildi;

                return matchesSearch && matchesStatus;
            });

            document.getElementById('stats').innerText = `${filteredData.length} DOSYA LİSTELENDİ`;

            filteredData.forEach((item) => {
                const tr = document.createElement('tr');
                tr.className = `group hover:bg-white/60 transition-all ${item.completed ? 'completed-row' : ''} ${item.vazgecildi ? 'cancelled-row' : ''}`;
                
                tr.innerHTML = `
                    <td class="px-6 py-5 text-center flex items-center justify-center gap-2">
                        <input type="checkbox" ${item.completed ? 'checked' : ''} onchange="toggleComplete(${item.id})" class="w-6 h-6 rounded-lg border-slate-300 text-indigo-500 cursor-pointer transition-all">
                    </td>
                    <td class="px-6 py-5">
                        <div class="text-slate-800 font-bold">#${item.basvuruNo}</div>
                        <div class="text-[10px] text-slate-400 font-bold uppercase">FK: ${item.fenKayitNo}</div>
                    </td>
                    <td class="px-6 py-5">
                        <div class="text-slate-700 font-semibold text-sm">${item.ilce}</div>
                        <div class="text-xs text-slate-500">${item.mahalle}</div>
                    </td>
                    <td class="px-6 py-5">
                        <span class="bg-indigo-50 text-indigo-600 px-3 py-1.5 rounded-xl font-bold text-xs border border-indigo-100">
                            ${item.ada} / ${item.parsel}
                        </span>
                    </td>
                    <td class="px-6 py-5">
                        <div class="text-[11px] font-bold text-slate-700"><i class="fas fa-user-tie text-slate-400 mr-1"></i> ${item.muhendis}</div>
                        <div class="text-[11px] text-slate-500"><i class="fas fa-user-cog text-slate-300 mr-1"></i> ${item.tekniker}</div>
                    </td>
                    <td class="px-6 py-5">
                        <div class="flex flex-col gap-1 text-[10px] font-bold">
                            <span class="flex items-center gap-1.5 text-slate-500"><i class="fas fa-calendar-alt w-3"></i> G: ${item.tescilGonderimTarihi}</span>
                            ${item.tescilGelisTarihi ? `<span class="flex items-center gap-1.5 text-emerald-600"><i class="fas fa-check-circle w-3"></i> T: ${item.tescilGelisTarihi}</span>` : ''}
                            ${item.iadeTarihi ? `<span class="flex items-center gap-1.5 text-rose-500"><i class="fas fa-times-circle w-3"></i> İ: ${item.iadeTarihi}</span>` : ''}
                            ${item.vazgecildi ? `<span class="flex items-center gap-1.5 text-amber-600"><i class="fas fa-ban w-3"></i> V: ${item.vazgecildi}</span>` : ''}
                        </div>
                    </td>
                    <td class="px-6 py-5"><p class="text-xs text-slate-500 italic max-w-[150px] truncate" title="${item.notlar || ''}">${item.notlar || '-'}</p></td>
                    <td class="px-6 py-5 text-center">
                        <div class="flex items-center justify-center gap-1">
                            <button onclick="toggleCancel(${item.id})" class="p-2 text-slate-400 hover:text-amber-500 hover:bg-amber-50 rounded-xl transition-all" title="Vazgeçildi">
                                <i class="fas fa-ban"></i>
                            </button>
                            <button onclick="deleteRow(${item.id})" class="opacity-0 group-hover:opacity-100 p-2 text-slate-300 hover:text-rose-500 hover:bg-rose-50 rounded-xl transition-all" title="Sil">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </div>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        document.getElementById('recordForm').onsubmit = async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const newRecord = { id: Date.now(), createdAt: new Date().toISOString(), completed: false, vazgecildi: null, ...Object.fromEntries(formData) };
            allData.unshift(newRecord);
            renderTable();
            toggleForm();
            e.target.reset();
            document.getElementById('mahalleSelect').innerHTML = '<option value="">Önce İlçe</option>';
            await saveData();
        };

        async function toggleComplete(id) {
            const idx = allData.findIndex(i => i.id === id);
            allData[idx].completed = !allData[idx].completed;
            renderTable();
            await saveData();
        }

        async function toggleCancel(id) {
            const idx = allData.findIndex(i => i.id === id);
            if (allData[idx].vazgecildi) {
                allData[idx].vazgecildi = null;
            } else {
                const today = new Date().toLocaleDateString('tr-TR');
                allData[idx].vazgecildi = today;
            }
            renderTable();
            await saveData();
        }

        async function deleteRow(id) {
            if (confirm('Müdürüm bu kaydı siliyorum, emin misiniz?')) {
                allData = allData.filter(i => i.id !== id);
                renderTable();
                await saveData();
            }
        }

        function exportToExcel(period) {
            const now = new Date();
            let filtered = [...allData];
            if (period === 'daily') filtered = allData.filter(i => new Date(i.createdAt).toDateString() === now.toDateString());
            else if (period === 'weekly') filtered = allData.filter(i => (now - new Date(i.createdAt)) / 86400000 <= 7);
            else if (period === 'monthly') filtered = allData.filter(i => new Date(i.createdAt).getMonth() === now.getMonth());
            else if (period === 'yearly') filtered = allData.filter(i => new Date(i.createdAt).getFullYear() === now.getFullYear());

            const excelData = filtered.map(i => ({
                "Durum": i.vazgecildi ? "VAZGEÇİLDİ" : (i.completed ? "TAMAMLANDI" : "AKTiF"),
                "Başvuru No": i.basvuruNo, "Fen Kayıt No": i.fenKayitNo, "İlçe": i.ilce, "Mahalle": i.mahalle,
                "Ada": i.ada, "Parsel": i.parsel, "Mühendis": i.muhendis, "Tekniker": i.tekniker,
                "Tescile Gidiş": i.tescilGonderimTarihi, "Tescilden Geliş": i.tescilGelisTarihi || "-", 
                "İade Tarihi": i.iadeTarihi || "-", "Vazgeçilme Tarihi": i.vazgecildi || "-", "Notlar": i.notlar || ""
            }));
            const ws = XLSX.utils.json_to_sheet(excelData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "MEGSIS");
            XLSX.writeFile(wb, `MEGSIS_${period}_Rapor.xlsx`);
        }
    </script>
</body>
</html>
